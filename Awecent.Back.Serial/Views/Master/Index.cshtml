
@{
    ViewBag.Title = "Index";
}
<style>
    .row {
        margin:5px 0;
    }
    div#myModalUpdate .modal-dialog {
        width:70%;
    }
</style>
<h2>Master Code</h2>
<form ng-app="MyApp" ng-controller="MasterCodeController" name="ValidateForm" id="ValidateForm">
    <div class="row"><a class="btn btn-sm btn-primary" href="@Url.Action("Create","Master")">Create</a></div>
    <div class="row">

        <div class="panel panel-default">
            <div class="panel-heading">Filter</div>
            <div class="panel-body">
                <div class="col-sm-4">
                    <label>Game Name</label>
                    <select ng-model="input.GameID" ng-change="findPromotion()" class="form-control" name="GameID">
                        @foreach (Awecent.Back.Serial.Models.Game game in ViewBag.Games)
                        {
                            <option value="@game.GameId">@game.GameName</option>
                        }
                    </select>
                </div>
                <div class="col-sm-1">
                    <button class="btn btn-info" type="button" ng-click="search()" style="margin-top:23px;">Search</button>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">Promotions</div>
            <div class="panel-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <td>ProID</td>
                            <td>Name</td>
                            <td>Code</td>
                            <td>CreateDate</td>
                            <td>Create by</td>
                            <td>StartDate</td>
                            <td>EndDate</td>
                            <td>Status</td>
                            <td>#</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="object in table">
                            <td>{{object.PromotionID}}</td>
                            <td>{{object.PromotionName}}</td>
                            <td>{{object.Code}}</td>
                            <td>{{convertDate(object.CreateDate) | date:'yyyy-MM-dd HH:mm:ss'}}</td>
                            <td>{{object.CreateUser}}</td>
                            <td>{{convertDate(object.StartDate) | date:'yyyy-MM-dd HH:mm:ss'}}</td>
                            <td>{{convertDate(object.EndDate) | date:'yyyy-MM-dd HH:mm:ss'}}</td>
                            <td>{{object.Status}}</td>
                            <td><a href="javascript://" ng-click="getDetail($index);showModel()">edit</a></td>
                        </tr>
                        
                    </tbody>
                </table>

                <uib-pagination total-items="input.total" ng-model="input.page" max-size="20"
                                ng-change="search()" items-per-page="input.pageSize"></uib-pagination>

            
            </div>
        </div>
    </div>

    @Html.Partial("~/Views/Master/_UpdateModel.cshtml")

</form>
@section Scripts{
    <script type="text/javascript">
        angular.module('MyApp', ['ui.bootstrap']).controller('MasterCodeController', ['$scope', '$http', function ($scope, $http) {
            $scope.input = {};
            $scope.input.page = 1;
            $scope.input.pageSize = 5;
            $scope.input.total = 0;
            
            $scope.serialtypes = [{ id: '1', name: 'Master Serial' }, { id: '2', name: 'Raw Serial' }];
            $scope.generateTypes = [{ id: '1', name: 'Generate' }, { id: '2', name: 'Import' }];

            $scope.table = [];

            $scope.showModel = function () {
                $('#myModalUpdate').modal('show')
            }

            $scope.search = function () {
                $http.post('@Url.Action("SearchMaster", "Master")', $scope.input)
                    .success(function (d) {
                        if (d.Result) {
                            $scope.table = d.Data;
                            console.log('data', d.Data[0]);

                            $scope.convertDate(d.Data[0].StartDate);

                            $scope.input.total = d.Total;
                            notifyInfo("record "+d.Data.length+'/'+d.Total);
                        }
                });
            }

            $scope.getDetail = function (index) {
                $scope.input = $scope.table[index];
                $scope.input.StartDate = $scope.convertDate($scope.table[index].StartDate);
                $scope.input.EndDate = $scope.convertDate($scope.table[index].EndDate);
            }

            $scope.convertDate = function (strDate) {
                if (strDate == null) return;
                if (strDate instanceof Date) return strDate;
                var milisec = strDate.substring(6 , strDate.length -2);
                var longMili = parseFloat(milisec);
                var myDate = new Date(longMili);
                return myDate;
            }

        }]);



    </script>    
}